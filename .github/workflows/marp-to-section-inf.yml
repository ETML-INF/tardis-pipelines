name: TARDIS - Build marp presentations

on:
  workflow_call:
    inputs:
      ict_module:
        description: "Code du module ICT (ex: I346)"
        required: true
        type: string
      theme_name:
        description: "Nom du th√®me Marp pr√©sent dans tardis-pipelines/themes/marp (ex: etml-2025)"
        required: false
        type: string
        default: "etml-2025"
    secrets:
      ftp_server:
        description: "Host FTP (ex: enseignement.section-inf.ch)"
        required: true
      ftp_username:
        description: "Compte FTP"
        required: true
      ftp_password:
        description: "Mot de passe FTP"
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      ICT_MODULE: ${{ inputs.ict_module }}
      THEME_NAME: ${{ inputs.theme_name }}
      PIPELINES_REPO: ETML-INF/tardis-pipelines
      PIPELINES_REF: main
    steps:
      - name: Check ICT_MODULE
        run: |
          set -euo pipefail
          if [ -z "${ICT_MODULE}" ]; then
            echo "::error::‚ùå ICT_MODULE non d√©fini. (input workflow_call: ict_module)"
            exit 1
          fi
          echo "‚úÖ ICT_MODULE=${ICT_MODULE}"
          echo "‚úÖ THEME_NAME=${THEME_NAME}"

      # 1) Checkout du d√©p√¥t APPELANT (cours)
      - name: Checkout caller repo
        uses: actions/checkout@v4
        with:
          path: caller

      # 2) Checkout de tardis-pipelines (th√®mes + index.php)
      - name: Checkout tardis-pipelines (themes)
        uses: actions/checkout@v4
        with:
          repository: ${{ env.PIPELINES_REPO }}
          ref: ${{ env.PIPELINES_REF }}
          path: pipelines

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install marp-cli
        run: npm i -g @marp-team/marp-cli

      - name: Build slides (HTML)
        run: |
          set -euo pipefail

          # D√©p√¥t appelant
          SRC_DIR="caller/b-UnitesEnseignement/Presentations"
          OUT_HTML="${SRC_DIR}/dist/html"
          mkdir -p "${OUT_HTML}"

          # Th√®mes dans tardis-pipelines
          PIPELINES_THEME_ROOT="pipelines/themes/marp"
          PIPELINES_THEME_DIR="${PIPELINES_THEME_ROOT}/${THEME_NAME}"
          PIPELINES_INDEX="${PIPELINES_THEME_ROOT}/index.php"

          if [ ! -d "${PIPELINES_THEME_DIR}" ]; then
            echo "::error::‚ùå Th√®me introuvable: ${PIPELINES_THEME_DIR}"
            ls -la "${PIPELINES_THEME_ROOT}" || true
            exit 1
          fi

          # Marp: theme-set doit viser le dossier qui contient les th√®mes
          THEME_SET_DIR="${PIPELINES_THEME_ROOT}"

          shopt -s nullglob
          FILES=(${SRC_DIR}/*.md)
          if [ ${#FILES[@]} -eq 0 ]; then
            echo "::warning::Aucun fichier .md trouv√© dans ${SRC_DIR}/"
          fi

          for f in "${FILES[@]}"; do
            base="$(basename "${f%.md}")"
            marp "${f}" --html --allow-local-files \
              --theme-set "${THEME_SET_DIR}" \
              --output "${OUT_HTML}/${base}.html"
          done

          # Index.php: vient de tardis-pipelines
          if [ -f "${PIPELINES_INDEX}" ]; then
            echo "‚ÑπÔ∏è index.php (tardis-pipelines) ‚Üí copie dans ${OUT_HTML}/"
            cp "${PIPELINES_INDEX}" "${OUT_HTML}/index.php"
          else
            echo "::warning::Aucun index.php trouv√© dans ${PIPELINES_THEME_ROOT}/"
          fi

          # Copier le th√®me + assets (fonts/img) pour que le HTML puisse les charger localement
          echo "‚ÑπÔ∏è Th√®me ${THEME_NAME} ‚Üí copie dans ${OUT_HTML}/style/${THEME_NAME}/"
          mkdir -p "${OUT_HTML}/style"
          cp -r "${PIPELINES_THEME_DIR}" "${OUT_HTML}/style/"

          # Copier aussi un √©ventuel assets/ du d√©p√¥t appelant (si tu en as)
          if [ -d "${SRC_DIR}/assets" ]; then
            echo "‚ÑπÔ∏è assets (caller) ‚Üí copie dans ${OUT_HTML}/assets/"
            cp -r "${SRC_DIR}/assets" "${OUT_HTML}/assets"
          fi

      - name: Upload slides artifact
        uses: actions/upload-artifact@v4
        with:
          name: slides-site
          path: caller/b-UnitesEnseignement/Presentations/dist/html/**
          if-no-files-found: error
          retention-days: 7

  deploy:
    needs: build
    runs-on: ubuntu-latest
    env:
      ICT_MODULE: ${{ inputs.ict_module }}
    steps:
      - name: ‚¨áÔ∏è Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: slides-site
          path: site/dist/html

      - name: üìÇ Sync pr√©sentations (HTML)
        uses: ETML-INF/tardis-pipelines/.github/actions/ftp-sync@main
        with:
          local-dir:     site/dist/html/
          ictroot-dir:   ${{ vars.ICT_ROOT_FOLDER }}
          ictmodule-dir: ${{ env.ICT_MODULE }}
          custom-dir:    ${{ vars.FTP_PRESENTATIONS_DIR }}
          state-name:    ".ftp-sync-deck.json"
          log-level:     "minimal"
          timeout:       "300000"
          ftp-server:    ${{ secrets.ftp_server }}
          ftp-username:  ${{ secrets.ftp_username }}
          ftp-password:  ${{ secrets.ftp_password }}
