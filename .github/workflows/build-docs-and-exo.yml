name: TARDIS â€“ Build docs & exercices PDF

on:
  workflow_call:
    inputs:
      ict_module:
        description: "Code du module ICT (ex: I346)"
        required: true
        type: string
      sphinx_src:
        description: "RÃ©pertoire Sphinx source"
        required: false
        default: "b-UnitesEnseignement/Support"
        type: string
      theme:
        description: "ThÃ¨me ETML (ex: etml-2025)"
        required: false
        default: "etml-2025"
        type: string

jobs:
  build-docs:
    runs-on: ubuntu-latest
    env:
      ICT_MODULE: ${{ inputs.ict_module }}
      SPHINX_SRC_DIR: ${{ inputs.sphinx_src }}

    steps:
      # 1) Repo APPELANT (le cours)
      - name: Checkout cours (repo appelant)
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}

      # 2) Repo tardis-pipelines (pour conf.py, extensions, requirements, thÃ¨mesâ€¦)
      - name: Checkout tardis-pipelines
        uses: actions/checkout@v4
        with:
          repository: ETML-INF/tardis-pipelines
          path: tardis-pipelines
          # plus tard: ref: v0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip (requirements TARDIS)
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('tardis-pipelines/requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install Python deps (TARDIS)
        run: |
          python -m pip install --upgrade pip
          pip install -r tardis-pipelines/requirements.txt

      - name: Build docs (HTML)
        run: |
          sphinx-build \
            -c tardis-pipelines \
            -b html "$SPHINX_SRC_DIR" "$SPHINX_SRC_DIR/_build/html"

      - name: Upload docs artifact (site HTML)
        uses: actions/upload-artifact@v4
        with:
          name: site-html
          path: ${{ env.SPHINX_SRC_DIR }}/_build/html/**
          if-no-files-found: error
          retention-days: 7

  build-exo-pdf:
    runs-on: ubuntu-latest
    needs: build-docs
    env:
      ICT_MODULE: ${{ inputs.ict_module }}
      SPHINX_SRC_DIR: ${{ inputs.sphinx_src }}
      HTML_OUT_DIR: ${{ inputs.sphinx_src }}/_build/html
      PDF_OUT_DIR: ${{ inputs.sphinx_src }}/_build/exo-pdf
      # Chemin complet vers le thÃ¨me dans tardis-pipelines
      TARDIS_THEME_ROOT: ${{ github.workspace }}/tardis-pipelines/themes/${{ inputs.theme }}

    steps:
      - name: Checkout cours (repo appelant)
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}

      - name: Checkout tardis-pipelines
        uses: actions/checkout@v4
        with:
          repository: ETML-INF/tardis-pipelines
          path: tardis-pipelines
          # plus tard: ref: v0

      - name: Download site HTML artifact
        uses: actions/download-artifact@v4
        with:
          name: site-html
          path: ${{ env.SPHINX_SRC_DIR }}/_build/html

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Playwright deps
        working-directory: tardis-pipelines
        run: |
          npm ci
          npx playwright install --with-deps chromium

      - name: Build exercices PDF (Playwright)
        working-directory: ${{ github.workspace }}
        run: |
          node tardis-pipelines/scripts/export_exos_pdf_playwright.mjs

      - name: Upload PDFs (raw)
        uses: actions/upload-artifact@v4
        with:
          name: exercices-pdf
          path: ${{ env.PDF_OUT_DIR }}/**
          if-no-files-found: warn
          retention-days: 7

      - name: ðŸ“‚ Sync cours (HTML)
        uses: ./.github/actions/ftp-sync
        with:
          local-dir: site/
          server-dir: ${{ vars.ICT_ROOT_FOLDER }}/${{ inputs.ict_module }}/${{ vars.FTP_DOCS_DIR }}/
          state-name: .ftp-sync-support.json
          log-level: minimal
          timeout: 300000

      - name: ðŸ“‚ Sync /exercices (PDF)
        uses: ./.github/actions/ftp-sync
        with:
          local-dir: exo-pdf/
          server-dir: ${{ vars.ICT_ROOT_FOLDER }}/${{ inputs.ict_module }}/${{ vars.FTP_EXO_DIR }}/
          state-name: .ftp-sync-exercices.json
          log-level: minimal
          timeout: 300000
