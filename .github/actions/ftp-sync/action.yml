name: "FTP Sync (ETML)"
description: "Synchronise un r√©pertoire local vers le serveur FTP ETML, avec cr√©ation conditionnelle du fichier d'√©tat."
author: "Section INF - ETML"

inputs:
  local-dir:
    description: "R√©pertoire local √† synchroniser"
    required: true

  server-dir:
    description: "R√©pertoire distant FTP (chemin relatif depuis la racine FTP)"
    required: true

  state-name:
    description: "Nom du fichier d‚Äô√©tat servant au delta FTP"
    required: false
    default: ".ftp-sync-state.json"

  log-level:
    description: "Niveau de logs SamKirkland (minimal/basic/standard/verbose)"
    required: false
    default: "minimal"

  timeout:
    description: "Timeout en millisecondes"
    required: false
    default: "300000"

runs:
  using: "composite"
  steps:

    # --------------------------------------------------------------------
    # 1) Cr√©ation du dossier remote si absent
    # --------------------------------------------------------------------
    - name: Create remote folder if missing
      shell: bash
      env:
        FTP_SERVER: ${{ vars.FTP_SERVER }}
        FTP_USER:   ${{ secrets.FTP_USERNAME }}
        FTP_PASS:   ${{ secrets.FTP_PASSWORD }}
      run: |
        set -euo pipefail

        remote_dir="${{ inputs.server-dir }}"

        echo "üìÅ V√©rification du dossier distant: ${remote_dir}"

        # Test si dossier existant
        if curl -sS --ftp-ssl --user "$FTP_USER:$FTP_PASS" \
           "ftp://$FTP_SERVER/${remote_dir}/" > /dev/null 2>&1; then
          echo "‚úîÔ∏è Dossier existe d√©j√† : ${remote_dir}"
        else
          echo "üìÇ Cr√©ation du dossier distant : ${remote_dir}"
          curl -sS --ftp-ssl --user "$FTP_USER:$FTP_PASS" \
            --quote "MKD ${remote_dir}" \
            "ftp://$FTP_SERVER/"
          echo "‚úîÔ∏è Dossier cr√©√©."
        fi


    # --------------------------------------------------------------------
    # 2) Upload conditionnel du fichier de state
    # --------------------------------------------------------------------
    - name: Upload remote FTP state file if missing
      shell: bash
      env:
        FTP_SERVER: ${{ vars.FTP_SERVER }}
        FTP_USER:   ${{ secrets.FTP_USERNAME }}
        FTP_PASS:   ${{ secrets.FTP_PASSWORD }}
      run: |
        set -euo pipefail

        state_name="${{ inputs.state-name }}"
        remote_dir="${{ inputs.server-dir }}"

        echo "üîç V√©rification du fichier d'√©tat sur le serveur : ${remote_dir}/${state_name}"

        # Listing du dossier distant
        listing=$(curl -sS --ftp-ssl \
          --user "$FTP_USER:$FTP_PASS" \
          "ftp://$FTP_SERVER/${remote_dir}/")

        if echo "$listing" | grep -q "^${state_name}$"; then
          echo "‚úîÔ∏è Fichier d'√©tat d√©j√† pr√©sent. Aucun upload n√©cessaire."
        else
          echo "üìÑ Fichier d'√©tat manquant. Upload du placeholder vide."
          echo "{}" > "$state_name"

          curl -sS --ftp-ssl \
            --user "$FTP_USER:$FTP_PASS" \
            --upload-file "$state_name" \
            "ftp://$FTP_SERVER/${remote_dir}/${state_name}"

          echo "‚úîÔ∏è Placeholder upload√© sur le serveur."
        fi


    # --------------------------------------------------------------------
    # 3) Synchronisation principale via FTP-Deploy-Action
    # --------------------------------------------------------------------
    - name: üìÇ FTP Sync via FTP-Deploy-Action
      uses: SamKirkland/FTP-Deploy-Action@v4.3.6
      with:
        server:     ${{ vars.FTP_SERVER }}
        username:   ${{ secrets.FTP_USERNAME }}
        password:   ${{ secrets.FTP_PASSWORD }}
        protocol:   ftps
        port:       21

        local-dir:  ${{ inputs.local-dir }}
        server-dir: ${{ inputs.server-dir }}
        state-name: ${{ inputs.state-name }}

        log-level:  ${{ inputs.log-level }}
        timeout:    ${{ inputs.timeout }}
