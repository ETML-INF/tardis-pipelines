name: "FTP Sync (ETML)"
description: "Synchronise un rÃ©pertoire local vers le serveur FTP ETML via SamKirkland/FTP-Deploy-Action"
author: "Section INF"

inputs:
  local-dir:
    description: "RÃ©pertoire local Ã  synchroniser"
    required: true
  server-dir:
    description: "RÃ©pertoire distant (FTP), ex: moduleICT/346/cours/"
    required: true
  state-name:
    description: "Nom du fichier d'Ã©tat pour le delta FTP"
    required: false
    default: ".ftp-sync-state.json"
  log-level:
    description: "Niveau de logs (minimal/basic/standard/verbose)"
    required: false
    default: "minimal"
  timeout:
    description: "Timeout en ms"
    required: false
    default: "300000"
  FTP_USERNAME:
    required: true
  FTP_SERVER:
    required: true
  FTP_PASSWORD:
    required: true
  


runs:
  using: "composite"
  steps:
    - name: ðŸ§ª Debug FTP env (optionnel)
      shell: bash
      run: |
        echo "FTP_SERVER=${{ inputs.FTP_SERVER }}"
        echo "FTP_USERNAME=${{ inputs.FTP_USERNAME }}"
        echo "REMOTE_DIR=${{ inputs.server-dir }}"
        echo "STATE_NAME=${{ inputs.state-name }}"

    - name: ðŸ§± CrÃ©er le dossier distant + placeholder de state si nÃ©cessaire
      shell: bash
      env:
        REMOTE_DIR: ${{ inputs.server-dir }}
        STATE_NAME: ${{ inputs.state-name }}
      run: |
        set -euo pipefail

        echo "URL = ftp://${FTP_SERVER}/${REMOTE_DIR}/"

        # 1) Tenter de lister le rÃ©pertoire (et le faire crÃ©er au besoin)
        curl -k --ssl-reqd --ftp-pasv \
          --user "${FTP_USERNAME}:${FTP_PASSWORD}" \
          "ftp://${FTP_SERVER}/${REMOTE_DIR}/" || true

        # 2) VÃ©rifier si le fichier de state existe dÃ©jÃ 
        echo "ðŸ” VÃ©rification du fichier de state: ${STATE_NAME}"
        if ! curl -k --ssl-reqd --ftp-pasv \
          --user "${FTP_USERNAME}:${FTP_PASSWORD}" \
          --head "ftp://${FTP_SERVER}/${REMOTE_DIR}/${STATE_NAME}" \
          >/dev/null 2>&1; then
          echo "ðŸ“ CrÃ©ation d'un placeholder de state vide..."
          echo "{}" > "${STATE_NAME}"

          curl -k --ssl-reqd --ftp-pasv \
            --user "${FTP_USERNAME}:${FTP_PASSWORD}" \
            --upload-file "${STATE_NAME}" \
            "ftp://${FTP_SERVER}/${REMOTE_DIR}/${STATE_NAME}"
        else
          echo "âœ… Fichier de state dÃ©jÃ  prÃ©sent."
        fi

    - name: ðŸ“‚ Sync via FTP-Deploy-Action
      uses: SamKirkland/FTP-Deploy-Action@v4.3.6
      with:
        server:   ${{ env.FTP_SERVER }}
        username: ${{ env.FTP_USERNAME }}
        password: ${{ env.FTP_PASSWORD }}
        protocol: ftps
        port: 21
        local-dir:  ${{ inputs.local-dir }}
        server-dir: ${{ inputs.server-dir }}
        state-name: ${{ inputs.state-name }}
        log-level:  ${{ inputs.log-level }}
        timeout:    ${{ inputs.timeout }}
