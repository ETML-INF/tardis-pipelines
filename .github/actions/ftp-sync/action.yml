name: "FTP Sync (ETML)"
description: "Synchronise un rÃ©pertoire local vers le serveur FTP via SamKirkland/FTP-Deploy-Action"
author: "Section INF"

inputs:
  ftp-server:
    description: "Nom ou IP du serveur FTP (sans protocol)"
    required: true
  ftp-username:
    description: "Utilisateur FTP"
    required: true
  ftp-password:
    description: "Mot de passe FTP"
    required: true

  local-dir:
    description: "RÃ©pertoire local Ã  synchroniser"
    required: true
  server-dir:
    description: "RÃ©pertoire distant (FTP, relatif Ã  la racine du compte)"
    required: true

  state-name:
    description: "Nom du fichier d'Ã©tat pour le delta FTP"
    required: false
    default: ".ftp-sync-state.json"

  log-level:
    description: "Niveau de logs (minimal/basic/standard/verbose)"
    required: false
    default: "minimal"

  timeout:
    description: "Timeout en ms"
    required: false
    default: "300000"

runs:
  using: "composite"
  steps:


    - name: Debug curl path
      shell: bash
      env:
          FTP_SERVER:  ${{ inputs.ftp-server }}
          FTP_USER:    ${{ inputs.ftp-username }}
          FTP_PASS:    ${{ inputs.ftp-password }}
          REMOTE_DIR:  ${{ inputs.server-dir }}
          STATE_NAME:  ${{ inputs.state-name }}
      run: |
        echo "URL = ftp://${FTP_SERVER}/${REMOTE_DIR}/"
        curl -v -k --ssl-reqd --ftp-pasv \
          --user "${FTP_USER}:${FTP_PASS}" \
          "ftp://${FTP_SERVER}/${REMOTE_DIR}/" || echo "â„¹ï¸ Listing initial Ã©chouÃ© (peut Ãªtre normal si le dossier n'existe pas)"



  
    - name: Ensure remote folder + state file exist
    # On crÃ©e le dossier distant si besoin puis un placeholder de state si absent
      shell: bash
      env:
        FTP_SERVER:  ${{ inputs.ftp-server }}
        FTP_USER:    ${{ inputs.ftp-username }}
        FTP_PASS:    ${{ inputs.ftp-password }}
        REMOTE_DIR:  ${{ inputs.server-dir }}
        STATE_NAME:  ${{ inputs.state-name }}
      run: |
        set -euo pipefail

        echo "ðŸ” VÃ©rification du rÃ©pertoire distant: ${REMOTE_DIR}"

        # 1) Tenter de lister le rÃ©pertoire ; si Ã§a Ã©choue, on le crÃ©e
        echo "ftp://${FTP_SERVER}:21/${REMOTE_DIR}"
        if ! curl -k -sS --ftp-ssl \
          --user "${FTP_USER}:${FTP_PASS}" \
          "ftp://${FTP_SERVER}:21/${REMOTE_DIR}/" > /dev/null 2>&1; then
          echo "ðŸ“ RÃ©pertoire inexistant, tentative de crÃ©ation..."
          curl -k -sS --ftp-ssl \
            --user "${FTP_USER}:${FTP_PASS}" \
            -Q "MKD /${REMOTE_DIR}" \
            "ftp://${FTP_SERVER}:21/" || echo "âš ï¸ MKD peut Ã©chouer si le dossier existe dÃ©jÃ  (ok)"
        else
          echo "âœ… RÃ©pertoire dÃ©jÃ  prÃ©sent."
        fi

        # 2) VÃ©rifier si le fichier de state est dÃ©jÃ  lÃ 
        echo "ðŸ” VÃ©rification du fichier de state: ${STATE_NAME}"
        if curl -k -sS --ftp-ssl\
          --user "${FTP_USER}:${FTP_PASS}" \
          "ftp://${FTP_SERVER}:21/${REMOTE_DIR}/" | grep -q "${STATE_NAME}"; then
          echo "âœ… Fichier de state dÃ©jÃ  prÃ©sent, rien Ã  faire."
        else
          echo "ðŸ“ CrÃ©ation d'un placeholder de state vide..."
          echo "{}" > "${STATE_NAME}"
          curl -k -sS --ftp-ssl \
            --user "${FTP_USER}:${FTP_PASS}" \
            --upload-file "${STATE_NAME}" \
            "ftp://${FTP_SERVER}:21/${REMOTE_DIR}/${STATE_NAME}"
        fi

    - name: ðŸ“‚ Sync via FTP-Deploy-Action
      uses: SamKirkland/FTP-Deploy-Action@v4.3.6
      with:
        server:     ${{ inputs.ftp-server }}
        username:   ${{ inputs.ftp-username }}
        password:   ${{ inputs.ftp-password }}
        protocol:   ftps
        port:       21
        local-dir:  ${{ inputs.local-dir }}
        server-dir: ${{ inputs.server-dir }}
        state-name: ${{ inputs.state-name }}
        log-level:  ${{ inputs.log-level }}
        timeout:    ${{ inputs.timeout }}
