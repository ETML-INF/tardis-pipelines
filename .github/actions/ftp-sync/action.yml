name: "FTP Sync (ETML)"
description: "Synchronise un rÃ©pertoire local vers le serveur FTP ETML via SamKirkland/FTP-Deploy-Action"
author: "Section INF"

inputs:
  local-dir:
    description: "RÃ©pertoire local Ã  synchroniser"
    required: true

  custom-dir:
    description: "RÃ©pertoire distant (FTP), ex: cours"
    required: true

  ictroot-dir:
    description: "RÃ©pertoire root des modules ICT, ex: moduleICT"
    required: true  

  ictmodule-dir:
    description: "Le rÃ©pertoire du module ICT, ex: 346"  
    required: true  

  state-name:
    description: "Nom du fichier d'Ã©tat pour le delta FTP"
    required: false
    default: ".ftp-sync-state.json"

  log-level:
    description: "Niveau de logs (minimal/basic/standard/verbose)"
    required: false
    default: "minimal"

  timeout:
    description: "Timeout en ms"
    required: false
    default: "300000"

  ftp-server:
    description: "Nom du serveur FTP (ex: enseignement.section-inf.ch)"
    required: true

  ftp-username:
    description: "Nom d'utilisateur FTP"
    required: true

  ftp-password:
    description: "Mot de passe FTP"
    required: true

runs:
  using: "composite"
  steps:
    - name: ðŸ”’ VÃ©rification des secrets requis
      env:
        FTP_SERVER: ${{ inputs.ftp-server }}
        FTP_USERNAME: ${{ inputs.ftp-username }}
        FTP_PASSWORD: ${{ inputs.ftp-password }}
      shell: bash
      run: |
        set -euo pipefail

        missing=0

        if [[ -z "${FTP_SERVER:-}" ]]; then
          echo "âŒ ERREUR : La variable FTP_SERVER est vide ou absente."
          missing=1
        fi

        if [[ -z "${FTP_USERNAME:-}" ]]; then
          echo "âŒ ERREUR : La variable FTP_USERNAME est vide ou absente."
          missing=1
        fi

        if [[ -z "${FTP_PASSWORD:-}" ]]; then
          echo "âŒ ERREUR : La variable FTP_PASSWORD est vide ou absente."
          missing=1
        fi

        if [[ "$missing" -eq 1 ]]; then
          echo "â›” ArrÃªt : Les secrets FTP ne sont pas transmis correctement depuis le workflow appelant."
          exit 1
        fi

        echo "âœ… Secrets FTP dÃ©tectÃ©s."

    - name: ðŸ§± CrÃ©er l'arborescence distante si nÃ©cessaire
      shell: bash
      env:
        FTP_SERVER:   ${{ inputs.ftp-server }}
        FTP_USERNAME: ${{ inputs.ftp-username }}
        FTP_PASSWORD: ${{ inputs.ftp-password }}

        ICTROOT:      ${{ inputs.ictroot-dir }}
        ICTMODULE:    ${{ inputs.ictmodule-dir }}
        CUSTOMDIR:    ${{ inputs.custom-dir }}
      run: |
        set -euo pipefail

        echo "ðŸ“ PrÃ©paration de l'arborescence distante:"
        echo "  /${ICTROOT}/${ICTMODULE}/${CUSTOMDIR}"

        # On se place Ã  la racine
        CURL="curl -k --ssl-reqd --ftp-pasv --silent --show-error --user ${FTP_USERNAME}:${FTP_PASSWORD}"

        # Aller dans la racine, puis ICTROOT
        $CURL --quote "CWD /"                                            "ftp://${FTP_SERVER}/" || true
        $CURL --quote "MKD ${ICTROOT}" --quote "CWD ${ICTROOT}"          "ftp://${FTP_SERVER}/" || true

        # Aller dans ICTMODULE
        $CURL --quote "MKD ${ICTMODULE}" --quote "CWD ${ICTMODULE}"      "ftp://${FTP_SERVER}/" || true

        # Aller dans CUSTOMDIR
        $CURL --quote "MKD ${CUSTOMDIR}" --quote "CWD ${CUSTOMDIR}"      "ftp://${FTP_SERVER}/" || true

        echo "âœ… Arborescence assurÃ©e."

    - name: ðŸ“ CrÃ©er placeholder state.json si nÃ©cessaire
      shell: bash
      env:
        FTP_SERVER:   ${{ inputs.ftp-server }}
        FTP_USERNAME: ${{ inputs.ftp-username }}
        FTP_PASSWORD: ${{ inputs.ftp-password }}

        ICTROOT:      ${{ inputs.ictroot-dir }}
        ICTMODULE:    ${{ inputs.ictmodule-dir }}
        CUSTOMDIR:    ${{ inputs.custom-dir }}
        STATE_NAME:   ${{ inputs.state-name }}
      run: |
        set -euo pipefail

        TARGET_URL="ftp://${FTP_SERVER}/${ICTROOT}/${ICTMODULE}/${CUSTOMDIR}/${STATE_NAME}"

        echo "ðŸ” VÃ©rification du fichier state : ${TARGET_URL}"

        if ! curl -k --ssl-reqd --ftp-pasv \
          --user "${FTP_USERNAME}:${FTP_PASSWORD}" \
          --head "${TARGET_URL}" >/dev/null 2>&1; then

          echo "ðŸ“ CrÃ©ation placeholder vide (${STATE_NAME})"
          echo "{}" > "${STATE_NAME}"

          curl -k --ssl-reqd --ftp-pasv \
            --user "${FTP_USERNAME}:${FTP_PASSWORD}" \
            --upload-file "${STATE_NAME}" \
            "${TARGET_URL}"
        else
          echo "âœ… Fichier de state dÃ©jÃ  prÃ©sent."
        fi

    - name: ðŸ“‚ Sync via FTP-Deploy-Action
      uses: SamKirkland/FTP-Deploy-Action@v4.3.6
      with:
        server:     ${{ inputs.ftp-server }}
        username:   ${{ inputs.ftp-username }}
        password:   ${{ inputs.ftp-password }}
        protocol:   ftps
        port:       21
        local-dir:  ${{ inputs.local-dir }}
        server-dir: ${{ inputs.ictroot-dir }}/${{ inputs.ictmodule-dir}}/${{ inputs.custom-dir }}/
        state-name: ${{ inputs.state-name }}
        log-level:  ${{ inputs.log-level }}
        timeout:    ${{ inputs.timeout }}
